<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Boston's Bike Sharing System</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>

    <title>Visualizing Boston's Bike Sharing System</title>
    <link rel="stylesheet" href="styleProject.css" />

    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200" rel="stylesheet">
    <!-- <script src="loadprojectdata2.js"></script> -->
  </head>
  <body>
        <h1 id="title">Visualizing Boston's Bike Sharing System</h1>  
        <h2 id="intro">The bluebikes, formally hubway bikes, is Boston's public bike share program. Since 2012, this system has increased access to various parts of boston through an active and affordable means of transportation. The data shows trip histories between XX dates. This visualization explores the expanding network of biking stations by gender, membership and age.  </h2>  
    <svg id="my-map"></svg>
    <div id="tooltip"></div>
    <script>

        var width = window.innerWidth;
        var height = 700;

        d3.queue()
            .defer(d3.csv, "201812-bluebikes-tripdata.csv")
            .defer(d3.csv, "stateNames.csv")
           //  .defer(d3.json, "ma-towns.json")
           .defer(d3.json, "MA-25-massachusetts-counties.json")
            .awaitAll(function(error, dataArray) {

                var data = dataArray[0];
                var names = dataArray[1];
                var stateTopojson = dataArray[2];

                var geoJSON = topojson.feature(stateTopojson, stateTopojson.objects.cb_2015_massachusetts_county_20m);
                console.log(geoJSON);

            //cb_2015_massachusetts_county_20m
               geoJSON.features = geoJSON.features.filter(function(state) {
                   return state.properties.NAME != "Barnstable" 
                   &&  state.properties.NAME != "Berkshire"
                   &&  state.properties.NAME != "Franklin" 
                   &&  state.properties.NAME != "Hampshire" 
                   &&  state.properties.NAME != "Hampden" 
                   &&  state.properties.NAME != "Worcester"
                   &&  state.properties.NAME != "Bristol"
                   &&  state.properties.NAME != "Essex"
                   &&  state.properties.NAME != "Dukes"
                   &&  state.properties.NAME != "Nantucket"
                   &&  state.properties.NAME != "Plymouth"
                 
                    ;
                });

                var projection = d3.geoMercator()
                    .fitSize([width, height], geoJSON) ;

                var path = d3.geoPath()
                    .projection(projection);

                var svg = d3.select("#my-map")
                    .attr("width", width + "px")
                    .attr("height", height + "px")
                    .style("fill", "gray")
                    .style('stroke-width', 3)
                    .append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .call(d3.zoom().on("zoom", function () {svg.attr("transform", d3.event.transform)}))
                    .append("g");

                

                var states = svg.selectAll("path")
                    .data(geoJSON.features);

                states.enter().append("path")
                    .attr("d", function(feature) {
                        return path(feature);
                    })
                    .attr("id", function(feature){
                        return "id-"+feature.id;
                    })
               

                    

                var nest = d3.nest()
                .key(function(d){return d.startstationname;})
                .forEach(function(d) {
                    d.average = d3.mean(d.values, function(row) {
                        return row.birthyear;
                    });
                })
                .entries(data)
                console.log(nest)

var colorScale = d3.scaleLinear()
                    .domain([0, 100]) //add extent
                    .range(["white", "blue"]);


                var features = svg.append("g")
            .attr("class","features");


                    features.selectAll("circle")
                    .data(nest)
                    .enter()
                    .append("circle")
                    .attr("transform", function(d) {
                         return "translate(" + projection([d.values[0].startstationlongitude, d.values[0].startstationlatitude]) + ")";})
                     .attr("r", .5)
                     .attr("fill", function(d) {
                return colorScale(d.values.length);
            })
       
            .on("mousemove", function(d) {
                var mouse = d3.mouse(document.body);
                d3.select("#tooltip")
                    .style("display", "block")
                    .html("<h3>" + d.key + "</h3>" +
                    "<h3>" + d.values.length + "</h3>"+
                    "<h3>" + d.values.gender + "</h3>")
                    .style("left", mouse[0] + "px")
                    .style("top", mouse[1] - 50 + "px");  })
            .on("mouseout", function(d) {
                d3.select("#tooltip")
                    .style("display", "none")
            });


        });

    </script>
  </body>
</html>